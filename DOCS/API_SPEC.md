# API

## Терминология:

+ **Узел** - любой из двух компьютеров, между которыми установлено соединение.
+ **Сервер** - узел, занимающий распределением сообщений между пользователями.
+ **Клиент** - узел, занимающийся передачей сообщений от лица одного пользователя.
+ **Пользователь** - человек, использующий клиент.
+ **Сообщение** - текстовое послание одного пользователя к другому.
+ **Пакет** - единица передачи оформленных данных между узлами.
+ **Запрос** - пакет, инициирующий активность удаленного узла и подразумевающий реакцию со сторону удаленного узла.
+ **Ответ** - пакет, сообщающий результаты выполнения запроса.

## Общие сведения

Данные между узлами передаются по протоколу WebSocket. Пакеты кодируются в JSON и имеют общий формат:
```
{
  "id": <...>,
  <доп. данные>,
}
<нулевой байт>
```
* `id`:строка - id пакета, который используется для ассоциации запросов с ответами. В пределах одного подключения id пар запрос-ответ не обязательно должны быть уникальными, до тех пор пока это не мешает соотносить соотносить эти пары.

Текст пакета гарантировано начинается с открывающей фигурной скобки и заканчивается закрывающей скобкой и нулевым байтом. Возможно наличие вложенных фигурных скобок.

Табуляция, пробелы и переносы строк не регламентируются.

Запросы кодируются в следующем формате:
```
{
  "id": <...>,
  "req": <...>,
  <доп. данные>,
}
<нулевой байт>
```
* `req`:строка - тип запроса, который характеризуют запрос в целом.

Ответы кодируются:
```
{
  "id": <...>,
  "status": <...>,
  "internal-error": <...>,
  <доп. данные>,
}
<нулевой байт>
```
* `id`:строка - id запроса, на который производится ответ.
* `status`:строка
  + `ok` означает успешное выполнение задачи для всех запросов.
  + `internal-error` означает внутреннюю ошибку сервера, не предусмотренную обработчиком запроса.
  + Каждый тип может резервировать дополнительные значения статуса.
* `internal-error` - если `status = internal-error`, содержит текст внутренней ошибки. В остальных случаях отсутствует.

## Типы запросов

### **К** `hello`

Регистрация пользователя.

Запрос:
```
{
  "id": <...>,
  "req": "hello",
  "username": <...>,
}
<нулевой байт>
```
* `username`:строка - имя пользователя.

Формат ответа:
```
{
  "id": <...>,
  "status": <...>,
  "suggestion": <...>,
}
<нулевой байт>
```
* `status`:строка
  + `ok` - регистрация успешна, клиент может отправлять сообщения
  + `taken` - имя пользователя уже занято
* `suggestion`:строка
  + При `status=taken` возвращает предлагаемое свободное имя пользователя.
  + При `status=ok` отсутствует или пусто.

### **К** `bye`

Завершение сессии и освобождение имени пользователя. Если клиент хочет продолжить отправлять сообщения, он должен снова отправить `hello`.

Не обязательно завершать все сессии запросом `bye`, как только клиент разрывает подключение. Запрос `bye` может быть использован для переименования пользователя.

Запрос:
```
{
  "id": <...>,
  "req": "bye",
}
<нулевой байт>
```

Ответ:
```
{
  "id": <...>,
  "status": "ok",
}
<нулевой байт>
```

### **КС** `msg`

При отправлении клиенту означает получение сообщения. При отправлении серверу означает отправку.

Запрос:
```
{
  "id": <...>,
  "req": "msg",
  "username": <...>,
  "msg": <...>,
}
<нулевой байт>
```

* `username`:строка - имя отправителя сообщения (при получении клиентов) или адресата сообщения (при получении сервером).
* `msg`:строка - текст сообщения.

Ответ:
```
{
  "id": <...>,
  "status": "ok",
}
<нулевой байт>
```

## Пример

Клиент подключается к серверу, регистрируется, отправляет пару сообщений, меняет имя пользователя и отключается.

Содержание пакетов отображено в краткой форме.

|Клиент|Сервер|
|---|---|
|*Соединение установлено*|*Соединение установлено*|
|**hello**(id=0, username=root)|-|
|-|**taken**(id=0, suggestion=root134)|
|**hello**(id=1, username=root134)|-|
|-|**ok**(id=1)|
|**msg**(id=2, username=root, text="You took my name!")|-|
|-|**internal-error**(id=2, internal-error="Access denied")|
|**msg**(id=3, username=root1, text="Who is root?")|-|
|-|**ok**(id=3)|
|-|**msg**(id=4, username=root1, text"He's the admin")|
|**ok**(id=4)|-|
|**bye**(id=5)|-|
|-|**ok**(id=5)|
|**hello**(id=6, username=butterfly)|-|
|-|**ok**(id=6)|
|**msg**(id=7, username=root1, text="Please, free your username")|-|
|**msg**(id=8, username=root2, text="Please, free your username")|-|
|-|**ok**(id=7)|
|**msg**(id=9, username=root3, text="Please, free your username")|-|
|-|**ok**(id=8)|
|-|**ok**(id=9)|
|*Соединение закрыто клиентом*|*Соединение закрыто клиентом*|
